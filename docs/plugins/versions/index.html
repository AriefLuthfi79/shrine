<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Versions · Shrine</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="The [`versions`][versions] plugin enables your uploader to deal with versions,"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Versions · Shrine"/><meta property="og:type" content="website"/><meta property="og:url" content="https://shrinerb.com/"/><meta property="og:description" content="The [`versions`][versions] plugin enables your uploader to deal with versions,"/><meta property="og:image" content="https://shrinerb.com/img/logo.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://shrinerb.com/img/logo.png"/><link rel="shortcut icon" href="/img/favicon.ico"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/zenburn.min.css"/><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-149836844-1', 'auto');
              ga('send', 'pageview');
            </script><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="/js/version.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100}
          )
        });
        </script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/logo.png" alt="Shrine"/><h2 class="headerTitleWithLogo">Shrine</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/docs/getting-started" target="_self">Guides</a></li><li class=""><a href="/docs/plugins/activerecord" target="_self">Plugins</a></li><li class=""><a href="/docs/external/extensions" target="_self">External</a></li><li class=""><a href="https://discourse.shrinerb.com" target="_self">Discourse</a></li><li class=""><a href="https://github.com/shrinerb/shrine" target="_self">GitHub</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><a class="edit-page-link button" href="https://github.com/shrinerb/shrine/edit/master/doc/plugins/versions.md" target="_blank" rel="noreferrer noopener">Edit</a><h1 class="postHeaderTitle">Versions</h1></header><article><div><span><p>The <a href="https://github.com/shrinerb/shrine/blob/master/lib/shrine/plugins/versions.rb"><code>versions</code></a> plugin enables your uploader to deal with versions,
by allowing you to return a Hash of files when processing.</p>
<pre><code class="hljs css language-rb">plugin <span class="hljs-symbol">:versions</span>
</code></pre>
<p>Here is an example of processing image thumbnails using the <a href="https://github.com/janko/image_processing">image_processing</a>
gem:</p>
<pre><code class="hljs css language-rb"><span class="hljs-keyword">require</span> <span class="hljs-string">"image_processing/mini_magick"</span>

plugin <span class="hljs-symbol">:processing</span>

process(<span class="hljs-symbol">:store</span>) <span class="hljs-keyword">do</span> <span class="hljs-params">|io, context|</span>
  versions = { <span class="hljs-symbol">original:</span> io } <span class="hljs-comment"># retain original</span>

  io.download <span class="hljs-keyword">do</span> <span class="hljs-params">|original|</span>
    pipeline = ImageProcessing::MiniMagick.source(original)

    versions[<span class="hljs-symbol">:large</span>]  = pipeline.resize_to_limit!(<span class="hljs-number">800</span>, <span class="hljs-number">800</span>)
    versions[<span class="hljs-symbol">:medium</span>] = pipeline.resize_to_limit!(<span class="hljs-number">500</span>, <span class="hljs-number">500</span>)
    versions[<span class="hljs-symbol">:small</span>]  = pipeline.resize_to_limit!(<span class="hljs-number">300</span>, <span class="hljs-number">300</span>)
  <span class="hljs-keyword">end</span>

  versions <span class="hljs-comment"># return the hash of processed files</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>You probably want to load the <code>delete_raw</code> plugin to automatically delete
processed files after they have been uploaded.</p>
<p>Now when you access the stored attachment through the model, a hash of uploaded
files will be returned:</p>
<pre><code class="hljs css language-rb">user.avatar_data <span class="hljs-comment">#=&gt;</span>
<span class="hljs-comment"># '{</span>
<span class="hljs-comment">#   "original": {"id":"0gsdf.jpg", "storage":"store", "metadata":{...}},</span>
<span class="hljs-comment">#   "large": {"id":"lg043.jpg", "storage":"store", "metadata":{...}},</span>
<span class="hljs-comment">#   "medium": {"id":"kd9fk.jpg", "storage":"store", "metadata":{...}},</span>
<span class="hljs-comment">#   "small": {"id":"932fl.jpg", "storage":"store", "metadata":{...}}</span>
<span class="hljs-comment"># }'</span>

user.avatar <span class="hljs-comment">#=&gt;</span>
<span class="hljs-comment"># {</span>
<span class="hljs-comment">#   :original =&gt; #&lt;Shrine::UploadedFile <span class="hljs-doctag">@data</span>={"id"=&gt;"0gsdf.jpg", ...}&gt;,</span>
<span class="hljs-comment">#   :large    =&gt; #&lt;Shrine::UploadedFile <span class="hljs-doctag">@data</span>={"id"=&gt;"lg043.jpg", ...}&gt;,</span>
<span class="hljs-comment">#   :medium   =&gt; #&lt;Shrine::UploadedFile <span class="hljs-doctag">@data</span>={"id"=&gt;"kd9fk.jpg", ...}&gt;,</span>
<span class="hljs-comment">#   :small    =&gt; #&lt;Shrine::UploadedFile <span class="hljs-doctag">@data</span>={"id"=&gt;"932fl.jpg", ...}&gt;,</span>
<span class="hljs-comment"># }</span>

user.avatar[<span class="hljs-symbol">:medium</span>]     <span class="hljs-comment">#=&gt; #&lt;Shrine::UploadedFile&gt;</span>
user.avatar[<span class="hljs-symbol">:medium</span>].url <span class="hljs-comment">#=&gt; "/uploads/store/lg043.jpg"</span>
</code></pre>
<p>The plugin also extends the <code>Attacher#url</code> to accept versions:</p>
<pre><code class="hljs css language-rb">user.avatar_url(<span class="hljs-symbol">:large</span>)
user.avatar_url(<span class="hljs-symbol">:small</span>, <span class="hljs-symbol">public:</span> <span class="hljs-literal">true</span>) <span class="hljs-comment"># with URL options</span>
</code></pre>
<p><code>Shrine.uploaded_file</code> will also instantiate a hash of <code>Shrine::UploadedFile</code>
objects if given data with versions. If you want to apply a change to all files
in an attachment, regardless of whether it consists of a single file or a hash
of versions, you can pass a block to <code>Shrine.uploaded_file</code> and it will yield
each file:</p>
<pre><code class="hljs css language-rb">Shrine.uploaded_file(attachment_data) <span class="hljs-keyword">do</span> <span class="hljs-params">|uploaded_file|</span>
  <span class="hljs-comment"># ...</span>
<span class="hljs-keyword">end</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="fallbacks"></a><a href="#fallbacks" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Fallbacks</h2>
<p>If versions are processed in a background job, there will be a period where the
user will browse the site before versions have finished processing. In this
period <code>Attacher#url</code> will by default fall back to the original file.</p>
<pre><code class="hljs css language-rb">user.avatar <span class="hljs-comment">#=&gt; #&lt;Shrine::UploadedFile&gt;</span>
user.avatar_url(<span class="hljs-symbol">:large</span>) <span class="hljs-comment"># falls back to `user.avatar_url`</span>
</code></pre>
<p>This behaviour is convenient if you want to gracefully degrade to the cached
file until the background job has finished processing. However, if you would
rather provide your own default URLs for versions, you can disable this
fallback:</p>
<pre><code class="hljs css language-rb">plugin <span class="hljs-symbol">:versions</span>, <span class="hljs-symbol">fallback_to_original:</span> <span class="hljs-literal">false</span>
</code></pre>
<p>If you already have some versions processed in the foreground after a
background job is kicked off (with the <code>recache</code> plugin), you can have URLs for
versions that are yet to be processed fall back to existing versions:</p>
<pre><code class="hljs css language-rb">plugin <span class="hljs-symbol">:versions</span>, <span class="hljs-symbol">fallbacks:</span> {
  <span class="hljs-symbol">:thumb_2x</span> =&gt; <span class="hljs-symbol">:thumb</span>,
  <span class="hljs-symbol">:large_2x</span> =&gt; <span class="hljs-symbol">:large</span>,
}

<span class="hljs-comment"># ... (background job is kicked off)</span>

user.avatar_url(<span class="hljs-symbol">:thumb_2x</span>) <span class="hljs-comment"># returns :thumb URL until :thumb_2x becomes available</span>
user.avatar_url(<span class="hljs-symbol">:large_2x</span>) <span class="hljs-comment"># returns :large URL until :large_2x becomes available</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="arrays"></a><a href="#arrays" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Arrays</h2>
<p>In addition to Hashes, the plugin also supports Arrays of files. For example,
you might want to split a PDf into pages:</p>
<pre><code class="hljs css language-rb">process(<span class="hljs-symbol">:store</span>) <span class="hljs-keyword">do</span> <span class="hljs-params">|io, context|</span>
  versions = { <span class="hljs-symbol">pages:</span> [] }

  io.download <span class="hljs-keyword">do</span> <span class="hljs-params">|pdf|</span>
    page_count = MiniMagick::Image.new(pdf.path).pages.count
    pipeline   = ImageProcessing::MiniMagick.source(pdf).convert(<span class="hljs-string">"jpg"</span>)

    page_count.times <span class="hljs-keyword">do</span> <span class="hljs-params">|page_number|</span>
      versions[<span class="hljs-symbol">:pages</span>] &lt;&lt; pipeline.loader(<span class="hljs-symbol">page:</span> page_number).call
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>

  versions
<span class="hljs-keyword">end</span>
</code></pre>
<p>You can also combine Hashes and Arrays, there is no limit to the level of
nesting.</p>
<h2><a class="anchor" aria-hidden="true" id="original-file"></a><a href="#original-file" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Original file</h2>
<p>It's recommended to always keep the original file after processing versions,
which you can do by adding the yielded <code>Shrine::UploadedFile</code> object as one of
the versions, by convention named <code>:original</code>:</p>
<pre><code class="hljs css language-rb">process(<span class="hljs-symbol">:store</span>) <span class="hljs-keyword">do</span> <span class="hljs-params">|io, context|</span>
  <span class="hljs-comment"># processing thumbnail</span>
  { <span class="hljs-symbol">original:</span> io, <span class="hljs-symbol">thumbnail:</span> thumbnail }
<span class="hljs-keyword">end</span>
</code></pre>
<p>If both temporary and permanent storage are Amazon S3, the cached original will
simply be copied over to permanent storage (without any downloading and
reuploading), so in these cases the performance impact of storing the original
file in addition to processed versions is neglibible.</p>
<h2><a class="anchor" aria-hidden="true" id="context"></a><a href="#context" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Context</h2>
<p>The version name will be available via <code>:version</code> when generating location or a
default URL.</p>
<pre><code class="hljs css language-rb"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">generate_location</span><span class="hljs-params">(io, context)</span></span>
  <span class="hljs-string">"uploads/<span class="hljs-subst">#{context[<span class="hljs-symbol">:version</span>]}</span>-<span class="hljs-subst">#{<span class="hljs-keyword">super</span>}</span>"</span>
<span class="hljs-keyword">end</span>

Attacher.default_url <span class="hljs-keyword">do</span> <span class="hljs-params">|options|</span>
  <span class="hljs-string">"/images/defaults/<span class="hljs-subst">#{options[<span class="hljs-symbol">:version</span>]}</span>.jpg"</span>
<span class="hljs-keyword">end</span>
</code></pre>
</span></div></article></div><div class="docs-prevnext"></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#fallbacks">Fallbacks</a></li><li><a href="#arrays">Arrays</a></li><li><a href="#original-file">Original file</a></li><li><a href="#context">Context</a></li></ul></nav></div><footer class="nav-footer" id="footer" data-version="3.0.0"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/logo.png" alt="Shrine" width="66"/></a><div><h5>Docs</h5><a href="/guides">Guides</a><a href="/plugins">Plugins</a><a href="/external">External</a><a href="https://github.com/shrinerb/shrine/blob/master/CONTRIBUTING.md#readme">Contributing</a></div><div><h5>Community</h5><a href="https://discourse.shrinerb.com" target="_blank" rel="noreferrer noopener">Discourse</a><a href="https://stackoverflow.com/questions/tagged/shrine" target="_blank" rel="noreferrer noopener">Stack Overflow</a></div><div><h5>More</h5><a href="https://twin.github.io">Blog</a><a href="https://github.com/shrinerb/shrine">GitHub</a><a class="github-button" href="https://github.com/shrinerb/shrine" data-icon="octicon-star" data-count-href="/shrinerb/shrine/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a><div class="social"><a href="https://twitter.com/shrine_rb" class="twitter-follow-button">Follow @shrine_rb</a></div></div></section><section class="copyright">Copyright © 2019 Janko Marohnić</section></footer></div><script>window.twttr=(function(d,s, id){var js,fjs=d.getElementsByTagName(s)[0],t=window.twttr||{};if(d.getElementById(id))return t;js=d.createElement(s);js.id=id;js.src='https://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js, fjs);t._e = [];t.ready = function(f) {t._e.push(f);};return t;}(document, 'script', 'twitter-wjs'));</script></body></html>