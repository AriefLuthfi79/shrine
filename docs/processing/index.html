<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>File Processing · Shrine</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="Shrine allows you to process attached files up front or on-the-fly. For"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="File Processing · Shrine"/><meta property="og:type" content="website"/><meta property="og:url" content="https://shrinerb.com/"/><meta property="og:description" content="Shrine allows you to process attached files up front or on-the-fly. For"/><meta property="og:image" content="https://shrinerb.com/img/logo.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://shrinerb.com/img/logo.png"/><link rel="shortcut icon" href="/img/favicon.ico"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/zenburn.min.css"/><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-149836844-1', 'auto');
              ga('send', 'pageview');
            </script><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="/js/version.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100}
          )
        });
        </script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/logo.png" alt="Shrine"/><h2 class="headerTitleWithLogo">Shrine</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/docs/getting-started" target="_self">Guides</a></li><li class=""><a href="/docs/plugins/activerecord" target="_self">Plugins</a></li><li class=""><a href="/docs/external/extensions" target="_self">External</a></li><li class=""><a href="https://discourse.shrinerb.com" target="_self">Discourse</a></li><li class=""><a href="https://github.com/shrinerb/shrine" target="_self">GitHub</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Features</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Base</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/getting-started">Getting Started</a></li><li class="navListItem"><a class="navItem" href="/docs/design">The Design of Shrine</a></li><li class="navListItem"><a class="navItem" href="/docs/retrieving-uploads">Retrieving Uploads</a></li><li class="navListItem"><a class="navItem" href="/docs/attacher">Using Attacher</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Features</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/direct-s3">Direct Uploads to S3</a></li><li class="navListItem"><a class="navItem" href="/docs/metadata">Extracting Metadata</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/processing">File Processing</a></li><li class="navListItem"><a class="navItem" href="/docs/validation">File Validation</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Extras</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/multiple-files">Multiple Files</a></li><li class="navListItem"><a class="navItem" href="/docs/securing-uploads">Securing uploads</a></li><li class="navListItem"><a class="navItem" href="/docs/testing">Testing with Shrine</a></li><li class="navListItem"><a class="navItem" href="/docs/upgrading-to-3">Upgrading to Shrine 3.x</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Migrating</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/changing-derivatives">Managing Derivatives</a></li><li class="navListItem"><a class="navItem" href="/docs/changing-location">Migrating File Locations</a></li><li class="navListItem"><a class="navItem" href="/docs/changing-storage">Migrating File Storage</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Extending</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/creating-plugins">Writing a Plugin</a></li><li class="navListItem"><a class="navItem" href="/docs/creating-persistence-plugins">Writing a Persistence Plugin</a></li><li class="navListItem"><a class="navItem" href="/docs/creating-storages">Writing a Storage</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Comparison</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/advantages">Advantages of Shrine</a></li><li class="navListItem"><a class="navItem" href="/docs/carrierwave">Shrine for CarrierWave Users</a></li><li class="navListItem"><a class="navItem" href="/docs/paperclip">Shrine for Paperclip Users</a></li><li class="navListItem"><a class="navItem" href="/docs/refile">Shrine for Refile Users</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><a class="edit-page-link button" href="https://github.com/shrinerb/shrine/edit/master/doc/processing.md" target="_blank" rel="noreferrer noopener">Edit</a><h1 class="postHeaderTitle">File Processing</h1></header><article><div><span><p>Shrine allows you to process attached files up front or on-the-fly. For
example, if your app is accepting image uploads, you can generate a predefined
set of of thumbnails when the image is attached to a record, or you can have
thumbnails generated dynamically as they're needed.</p>
<p>How you're going to implement processing is entirely up to you. For images it's
recommended to use the <strong><a href="https://github.com/janko/image_processing">ImageProcessing</a></strong> gem, which provides wrappers for
processing with <a href="https://www.imagemagick.org">ImageMagick</a>/<a href="http://www.graphicsmagick.org">GraphicsMagick</a> (using the <a href="https://github.com/minimagick/minimagick">MiniMagick</a> gem) or
<a href="http://libvips.github.io/libvips/">libvips</a> (using the <a href="https://github.com/libvips/ruby-vips">ruby-vips</a> gem; see the <a href="#libvips">libvips section</a>).
Here is an example of generating a thumbnail with ImageProcessing:</p>
<pre><code class="hljs css language-sh">$ brew install imagemagick
</code></pre>
<pre><code class="hljs css language-rb"><span class="hljs-comment"># Gemfile</span>
gem <span class="hljs-string">"image_processing"</span>, <span class="hljs-string">"~&gt; 1.8"</span>
</code></pre>
<pre><code class="hljs css language-rb"><span class="hljs-keyword">require</span> <span class="hljs-string">"image_processing/mini_magick"</span>

thumbnail = ImageProcessing::MiniMagick
  .source(image)
  .resize_to_limit!(<span class="hljs-number">600</span>, <span class="hljs-number">400</span>)

thumbnail <span class="hljs-comment">#=&gt; #&lt;Tempfile:...&gt; (a 600x400 thumbnail of the source image)</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="processing-up-front"></a><a href="#processing-up-front" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Processing up front</h2>
<p>Let's say we're handling images, and want to generate a predefined set of
thumbnails with various dimensions. We can use the <code>derivatives</code> plugin to
upload and save the processed files:</p>
<pre><code class="hljs css language-rb">Shrine.plugin <span class="hljs-symbol">:derivatives</span>
</code></pre>
<pre><code class="hljs css language-rb"><span class="hljs-keyword">require</span> <span class="hljs-string">"image_processing/mini_magick"</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ImageUploader</span> &lt; Shrine</span>
  Attacher.derivatives_processor <span class="hljs-keyword">do</span> <span class="hljs-params">|original|</span>
    magick = ImageProcessing::MiniMagick.source(original)

    {
      <span class="hljs-symbol">large:</span>  magick.resize_to_limit!(<span class="hljs-number">800</span>, <span class="hljs-number">800</span>),
      <span class="hljs-symbol">medium:</span> magick.resize_to_limit!(<span class="hljs-number">500</span>, <span class="hljs-number">500</span>),
      <span class="hljs-symbol">small:</span>  magick.resize_to_limit!(<span class="hljs-number">300</span>, <span class="hljs-number">300</span>),
    }
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<pre><code class="hljs css language-rb">photo = Photo.new(<span class="hljs-symbol">image:</span> file)
photo.image_derivatives! <span class="hljs-comment"># calls derivatives processor</span>
photo.save
</code></pre>
<p>After the processed files are uploaded, their data is saved into the
<code>&lt;attachment&gt;_data</code> column. You can then retrieve the derivatives as
<a href="http://shrinerb.com/rdoc/classes/Shrine/UploadedFile/InstanceMethods.html"><code>Shrine::UploadedFile</code></a> objects:</p>
<pre><code class="hljs css language-rb">photo.image(<span class="hljs-symbol">:large</span>)            <span class="hljs-comment">#=&gt; #&lt;Shrine::UploadedFile ...&gt;</span>
photo.image(<span class="hljs-symbol">:large</span>).url        <span class="hljs-comment">#=&gt; "/uploads/store/lg043.jpg"</span>
photo.image(<span class="hljs-symbol">:large</span>).size       <span class="hljs-comment">#=&gt; 5825949</span>
photo.image(<span class="hljs-symbol">:large</span>).mime_type  <span class="hljs-comment">#=&gt; "image/jpeg"</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="automatic-processing"></a><a href="#automatic-processing" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Automatic processing</h3>
<p>If you would like derivatives to be automatically created with promotion, you
can override <code>Attacher#promote</code> for call <code>Attacher#create_derivatives</code> before
promotion:</p>
<pre><code class="hljs css language-rb"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Shrine::Attacher</span></span>
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">promote</span><span class="hljs-params">(*)</span></span>
    create_derivatives
    <span class="hljs-keyword">super</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="backgrounding"></a><a href="#backgrounding" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Backgrounding</h3>
<p>Since file processing can be time consuming, it's recommended to move it into a
background job.</p>
<h4><a class="anchor" aria-hidden="true" id="with-promotion"></a><a href="#with-promotion" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>With promotion</h4>
<p>The simplest way is to use the <a href="https://shrinerb.com/docs/plugins/backgrounding"><code>backgrounding</code></a> plugin to move
promotion into a background job, and then create derivatives as part of
promotion:</p>
<pre><code class="hljs css language-rb">Shrine.plugin <span class="hljs-symbol">:backgrounding</span>
Shrine::Attacher.promote_block <span class="hljs-keyword">do</span>
  PromoteJob.perform_async(<span class="hljs-keyword">self</span>.<span class="hljs-keyword">class</span>.name, record.<span class="hljs-keyword">class</span>.name, record.id, name, file_data)
<span class="hljs-keyword">end</span>
</code></pre>
<pre><code class="hljs css language-rb"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PromoteJob</span></span>
  <span class="hljs-keyword">include</span> Sidekiq::Worker

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">perform</span><span class="hljs-params">(attacher_class, record_class, record_id, name, file_data)</span></span>
    attacher_class = Object.const_get(attacher_class)
    record         = Object.const_get(record_class).find(record_id) <span class="hljs-comment"># if using Active Record</span>

    attacher = attacher_class.retrieve(<span class="hljs-symbol">model:</span> record, <span class="hljs-symbol">name:</span> name, <span class="hljs-symbol">file:</span> file_data)
    attacher.create_derivatives <span class="hljs-comment"># calls derivatives processor</span>
    attacher.atomic_promote
  <span class="hljs-keyword">rescue</span> Shrine::AttachmentChanged, ActiveRecord::RecordNotFound
    <span class="hljs-comment"># attachment has changed or the record has been deleted, nothing to do</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<h4><a class="anchor" aria-hidden="true" id="separate-from-promotion"></a><a href="#separate-from-promotion" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Separate from promotion</h4>
<p>Derivatives don't need to be created as part of the attachment flow, you can
create them at any point after promotion:</p>
<pre><code class="hljs css language-rb">DerivativesJob.perform_async(
  attacher.<span class="hljs-keyword">class</span>.name,
  attacher.record.<span class="hljs-keyword">class</span>.name,
  attacher.record.id,
  attacher.name,
  attacher.file_data,
)
</code></pre>
<pre><code class="hljs css language-rb"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DerivativesJob</span></span>
  <span class="hljs-keyword">include</span> Sidekiq::Worker

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">perform</span><span class="hljs-params">(attacher_class, record_class, record_id, name, file_data)</span></span>
    attacher_class = Object.const_get(attacher_class)
    record         = Object.const_get(record_class).find(record_id) <span class="hljs-comment"># if using Active Record</span>

    attacher = attacher_class.retrieve(<span class="hljs-symbol">model:</span> record, <span class="hljs-symbol">name:</span> name, <span class="hljs-symbol">file:</span> file_data)
    attacher.create_derivatives <span class="hljs-comment"># calls derivatives processor</span>
    attacher.atomic_persist
  <span class="hljs-keyword">rescue</span> Shrine::AttachmentChanged, ActiveRecord::RecordNotFound
    attacher&amp;.destroy_attached <span class="hljs-comment"># delete now orphaned derivatives</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<h4><a class="anchor" aria-hidden="true" id="concurrent-processing"></a><a href="#concurrent-processing" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Concurrent processing</h4>
<p>You can also generate derivatives concurrently:</p>
<pre><code class="hljs css language-rb"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ImageUploader</span> &lt; Shrine</span>
  THUMBNAILS = {
    <span class="hljs-symbol">large:</span>  [<span class="hljs-number">800</span>, <span class="hljs-number">800</span>],
    <span class="hljs-symbol">medium:</span> [<span class="hljs-number">500</span>, <span class="hljs-number">500</span>],
    <span class="hljs-symbol">small:</span>  [<span class="hljs-number">300</span>, <span class="hljs-number">300</span>],
  }

  Attacher.derivatives_processor <span class="hljs-keyword">do</span> <span class="hljs-params">|original, name:|</span>
    thumbnail = ImageProcessing::MiniMagick
      .source(original)
      .resize_to_limit!(*THUMBNAILS.fetch(name))

    { name =&gt; thumbnail }
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<pre><code class="hljs css language-rb">ImageUploader::THUMBNAILS.each_key <span class="hljs-keyword">do</span> <span class="hljs-params">|derivative_name|</span>
  DerivativeJob.perform_async(
    attacher.<span class="hljs-keyword">class</span>.name,
    attacher.record.<span class="hljs-keyword">class</span>.name,
    attacher.record.id,
    attacher.name,
    attacher.file_data,
    derivative_name,
  )
<span class="hljs-keyword">end</span>
</code></pre>
<pre><code class="hljs css language-rb"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DerivativeJob</span></span>
  <span class="hljs-keyword">include</span> Sidekiq::Worker

  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">perform</span><span class="hljs-params">(attacher_class, record_class, record_id, name, file_data, derivative_name)</span></span>
    attacher_class = Object.const_get(attacher_class)
    record         = Object.const_get(record_class).find(record_id) <span class="hljs-comment"># if using Active Record</span>

    attacher = attacher_class.retrieve(<span class="hljs-symbol">model:</span> record, <span class="hljs-symbol">name:</span> name, <span class="hljs-symbol">file:</span> file_data)
    attacher.create_derivatives(<span class="hljs-symbol">name:</span> derivative_name)
    attacher.atomic_persist <span class="hljs-keyword">do</span> <span class="hljs-params">|reloaded_attacher|</span>
      <span class="hljs-comment"># make sure we don't override derivatives created in other jobs</span>
      attacher.merge_derivatives(reloaded_attacher.derivatives)
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">rescue</span> Shrine::AttachmentChanged, ActiveRecord::RecordNotFound
    attacher.derivatives[derivative_name].delete <span class="hljs-comment"># delete now orphaned derivative</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="processing-other-filetypes"></a><a href="#processing-other-filetypes" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Processing other filetypes</h3>
<p>So far we've only been talking about processing images. However, there is
nothing image-specific in Shrine's processing API, you can just as well process
any other types of files. The processing tool doesn't need to have any special
Shrine integration, the ImageProcessing gem that we saw earlier is a completely
generic gem.</p>
<p>To demonstrate, here is an example of transcoding videos using
<a href="https://github.com/streamio/streamio-ffmpeg">streamio-ffmpeg</a>:</p>
<pre><code class="hljs css language-rb"><span class="hljs-comment"># Gemfile</span>
gem <span class="hljs-string">"streamio-ffmpeg"</span>
</code></pre>
<pre><code class="hljs css language-rb"><span class="hljs-keyword">require</span> <span class="hljs-string">"streamio-ffmpeg"</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">VideoUploader</span> &lt; Shrine</span>
  Attacher.derivatives_processor <span class="hljs-keyword">do</span> <span class="hljs-params">|original|</span>
    transcoded = Tempfile.new [<span class="hljs-string">"transcoded"</span>, <span class="hljs-string">".mp4"</span>]
    screenshot = Tempfile.new [<span class="hljs-string">"screenshot"</span>, <span class="hljs-string">".jpg"</span>]

    movie = FFMPEG::Movie.new(original.path)
    movie.transcode(transcoded.path)
    movie.screenshot(screenshot.path)

    { <span class="hljs-symbol">transcoded:</span> transcoded, <span class="hljs-symbol">screenshot:</span> screenshot }
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="on-the-fly-processing"></a><a href="#on-the-fly-processing" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>On-the-fly processing</h2>
<p>Generating image thumbnails on upload can be a pain to maintain, because
whenever you need to add a new version or change an existing one, you need to
retroactively apply it to all existing uploads (see the <a href="https://shrinerb.com/docs/changing-derivatives">Managing Derivatives</a>
guide for more details).</p>
<p>As an alternative, it's very common to instead generate thumbnails dynamically
as they're requested, and then cache them for future requests. This strategy is
known as &quot;on-the-fly processing&quot;, and it's suitable for short-running
processing such as creating image thumbnails or document previews.</p>
<p>Shrine provides on-the-fly processing functionality via the
<a href="https://shrinerb.com/docs/plugins/derivation_endpoint"><code>derivation_endpoint</code></a> plugin. The basic setup is the
following:</p>
<ol>
<li>load the plugin with a secret key and a path prefix for the endpoint</li>
<li>mount the endpoint into your main app's router</li>
<li>define a processing block for the type files you want to generate</li>
</ol>
<p>Together it might look something like this:</p>
<pre><code class="hljs css language-rb"><span class="hljs-keyword">require</span> <span class="hljs-string">"image_processing/mini_magick"</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ImageUploader</span> &lt; Shrine</span>
  plugin <span class="hljs-symbol">:derivation_endpoint</span>,
    <span class="hljs-symbol">secret_key:</span> <span class="hljs-string">"&lt;YOUR SECRET KEY&gt;"</span>,
    <span class="hljs-symbol">prefix:</span>     <span class="hljs-string">"derivations/image"</span>

  derivation <span class="hljs-symbol">:thumbnail</span> <span class="hljs-keyword">do</span> <span class="hljs-params">|file, width, height|</span>
    ImageProcessing::MiniMagick
      .source(file)
      .resize_to_limit!(width.to_i, height.to_i)
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<pre><code class="hljs css language-rb"><span class="hljs-comment"># config/routes.rb (Rails)</span>
Rails.application.routes.draw <span class="hljs-keyword">do</span>
  mount ImageUploader.derivation_endpoint =&gt; <span class="hljs-string">"derivations/image"</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>Now you can generate thumbnail URLs from attached files, and the actual
thumbnail will be generated when the URL is requested:</p>
<pre><code class="hljs css language-rb">photo.image.derivation_url(<span class="hljs-symbol">:thumbnail</span>, <span class="hljs-number">600</span>, <span class="hljs-number">400</span>)
<span class="hljs-comment">#=&gt; "/derivations/image/thumbnail/600/400/eyJpZCI6ImZvbyIsInN0b3JhZ2UiOiJzdG9yZSJ9?signature=..."</span>
</code></pre>
<p>The plugin is highly customizable, be sure to check out the
<a href="https://shrinerb.com/docs/plugins/derivation_endpoint">documentation</a>, especially the <a href="https://shrinerb.com/docs/plugins/derivation_endpoint#performance">performance
section</a>.</p>
<h2><a class="anchor" aria-hidden="true" id="extras"></a><a href="#extras" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Extras</h2>
<h3><a class="anchor" aria-hidden="true" id="libvips"></a><a href="#libvips" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>libvips</h3>
<p>As mentioned, ImageProcessing gem also has an alternative backend for
processing images with <strong><a href="http://libvips.github.io/libvips/">libvips</a></strong>. libvips is a full-featured image
processing library like ImageMagick, with impressive performance
characteristics – it's often <strong>multiple times faster</strong> than ImageMagick and has
low memory usage (see <a href="https://github.com/libvips/libvips/wiki/Why-is-libvips-quick">Why is libvips quick</a>).</p>
<p>Using libvips is as easy as installing it and switching to the
<code>ImageProcessing::Vips</code> backend:</p>
<pre><code class="hljs css language-sh">$ brew install vips
</code></pre>
<pre><code class="hljs css language-rb"><span class="hljs-comment"># Gemfile</span>
gem <span class="hljs-string">"image_processing"</span>, <span class="hljs-string">"~&gt; 1.8"</span>
</code></pre>
<pre><code class="hljs css language-rb"><span class="hljs-keyword">require</span> <span class="hljs-string">"image_processing/vips"</span>

<span class="hljs-comment"># all we did was replace `ImageProcessing::MiniMagick` with `ImageProcessing::Vips`</span>
thumbnail = ImageProcessing::Vips
  .source(image)
  .resize_to_limit!(<span class="hljs-number">600</span>, <span class="hljs-number">400</span>)

thumbnail <span class="hljs-comment">#=&gt; #&lt;Tempfile:...&gt; (a 600x400 thumbnail of the source image)</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="parallelize-uploading"></a><a href="#parallelize-uploading" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Parallelize uploading</h3>
<p>If you're generating derivatives, you can parallelize the uploads using the
<a href="https://github.com/ruby-concurrency/concurrent-ruby">concurrent-ruby</a> gem:</p>
<pre><code class="hljs css language-rb"><span class="hljs-comment"># Gemfile</span>
gem <span class="hljs-string">"concurrent-ruby"</span>
</code></pre>
<pre><code class="hljs css language-rb"><span class="hljs-keyword">require</span> <span class="hljs-string">"concurrent"</span>

derivatives = attacher.process_derivatives

tasks = derivatives.map <span class="hljs-keyword">do</span> <span class="hljs-params">|name, file|</span>
  Concurrent::Promises.future(name, file) <span class="hljs-keyword">do</span> <span class="hljs-params">|name, file|</span>
    attacher.add_derivative(name, file)
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

Concurrent::Promises.zip(*tasks).wait!
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="external-processing"></a><a href="#external-processing" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>External processing</h3>
<p>Since processing is so dynamic, you're not limited to using the ImageProcessing
gem, you can also use a 3rd-party service to generate thumbnails for you. Here
is an example of generating thumbnails on-the-fly using <a href="https://imageoptim.com/api">ImageOptim.com</a> (not
to be confused with the <a href="https://github.com/toy/image_optim">image_optim</a> gem):</p>
<pre><code class="hljs css language-rb"><span class="hljs-comment"># Gemfile</span>
gem <span class="hljs-string">"down"</span>, <span class="hljs-string">"~&gt; 5.0"</span>
gem <span class="hljs-string">"http"</span>, <span class="hljs-string">"~&gt; 4.0"</span>
</code></pre>
<pre><code class="hljs css language-rb"><span class="hljs-keyword">require</span> <span class="hljs-string">"down/http"</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ImageUploader</span> &lt; Shrine</span>
  plugin <span class="hljs-symbol">:derivation_endpoint</span>,
    <span class="hljs-symbol">secret_key:</span> <span class="hljs-string">"secret"</span>,
    <span class="hljs-symbol">prefix:</span>     <span class="hljs-string">"derivations/image"</span>,
    <span class="hljs-symbol">download:</span>   <span class="hljs-literal">false</span>

  derivation <span class="hljs-symbol">:thumbnail</span> <span class="hljs-keyword">do</span> <span class="hljs-params">|width, height|</span>
    <span class="hljs-comment"># generate thumbnails using ImageOptim.com</span>
    down = Down::Http.new(<span class="hljs-symbol">method:</span> <span class="hljs-symbol">:post</span>)
    down.download(<span class="hljs-string">"https://im2.io/&lt;USERNAME&gt;/<span class="hljs-subst">#{width}</span>x<span class="hljs-subst">#{height}</span>/<span class="hljs-subst">#{source.url}</span>"</span>)
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="cloudinary"></a><a href="#cloudinary" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Cloudinary</h3>
<p><a href="https://cloudinary.com">Cloudinary</a> is a popular commercial service for on-the-fly image processing,
so it's a good alternative to the <code>derivation_endpoint</code> plugin. The
<a href="https://github.com/shrinerb/shrine-cloudinary">shrine-cloudinary</a> gem provides a Shrine storage that we can set for our
temporary and permanent storage:</p>
<pre><code class="hljs css language-rb"><span class="hljs-comment"># Gemfile</span>
gem <span class="hljs-string">"shrine-cloudinary"</span>
</code></pre>
<pre><code class="hljs css language-rb"><span class="hljs-keyword">require</span> <span class="hljs-string">"cloudinary"</span>
<span class="hljs-keyword">require</span> <span class="hljs-string">"shrine/storage/cloudinary"</span>

Cloudinary.config(
  <span class="hljs-symbol">cloud_name:</span> <span class="hljs-string">"&lt;YOUR_CLOUD_NAME&gt;"</span>,
  <span class="hljs-symbol">api_key:</span>    <span class="hljs-string">"&lt;YOUR_API_KEY&gt;"</span>,
  <span class="hljs-symbol">api_secret:</span> <span class="hljs-string">"&lt;YOUR_API_SECRET&gt;"</span>,
)

Shrine.storages = {
  <span class="hljs-symbol">cache:</span> Shrine::Storage::Cloudinary.new(<span class="hljs-symbol">prefix:</span> <span class="hljs-string">"cache"</span>),
  <span class="hljs-symbol">store:</span> Shrine::Storage::Cloudinary.new,
}
</code></pre>
<p>Now when we upload our images to Cloudinary, we can generate URLs with various
processing parameters:</p>
<pre><code class="hljs css language-rb">photo.image_url(<span class="hljs-symbol">width:</span> <span class="hljs-number">100</span>, <span class="hljs-symbol">height:</span> <span class="hljs-number">100</span>, <span class="hljs-symbol">crop:</span> <span class="hljs-symbol">:fit</span>)
<span class="hljs-comment">#=&gt; "http://res.cloudinary.com/myapp/image/upload/w_100,h_100,c_fit/nature.jpg"</span>
</code></pre>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/metadata"><span class="arrow-prev">← </span><span>Extracting Metadata</span></a><a class="docs-next button" href="/docs/validation"><span>File Validation</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#processing-up-front">Processing up front</a><ul class="toc-headings"><li><a href="#automatic-processing">Automatic processing</a></li><li><a href="#backgrounding">Backgrounding</a></li><li><a href="#processing-other-filetypes">Processing other filetypes</a></li></ul></li><li><a href="#on-the-fly-processing">On-the-fly processing</a></li><li><a href="#extras">Extras</a><ul class="toc-headings"><li><a href="#libvips">libvips</a></li><li><a href="#parallelize-uploading">Parallelize uploading</a></li><li><a href="#external-processing">External processing</a></li><li><a href="#cloudinary">Cloudinary</a></li></ul></li></ul></nav></div><footer class="nav-footer" id="footer" data-version="3.0.0"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/logo.png" alt="Shrine" width="66"/></a><div><h5>Docs</h5><a href="/guides">Guides</a><a href="/plugins">Plugins</a><a href="/external">External</a><a href="https://github.com/shrinerb/shrine/blob/master/CONTRIBUTING.md#readme">Contributing</a></div><div><h5>Community</h5><a href="https://discourse.shrinerb.com" target="_blank" rel="noreferrer noopener">Discourse</a><a href="https://stackoverflow.com/questions/tagged/shrine" target="_blank" rel="noreferrer noopener">Stack Overflow</a></div><div><h5>More</h5><a href="https://twin.github.io">Blog</a><a href="https://github.com/shrinerb/shrine">GitHub</a><a class="github-button" href="https://github.com/shrinerb/shrine" data-icon="octicon-star" data-count-href="/shrinerb/shrine/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a><div class="social"><a href="https://twitter.com/shrine_rb" class="twitter-follow-button">Follow @shrine_rb</a></div></div></section><section class="copyright">Copyright © 2019 Janko Marohnić</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>window.twttr=(function(d,s, id){var js,fjs=d.getElementsByTagName(s)[0],t=window.twttr||{};if(d.getElementById(id))return t;js=d.createElement(s);js.id=id;js.src='https://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js, fjs);t._e = [];t.ready = function(f) {t._e.push(f);};return t;}(document, 'script', 'twitter-wjs'));</script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: '09a11b10801874df7d226df4f2ce8e8f',
                indexName: 'shrinerb',
                inputSelector: '#search_input_react'
              });
            </script></body></html>