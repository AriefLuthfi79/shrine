<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>AWS S3 · Shrine</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="The S3 storage handles uploads to Amazon S3 service, using the [aws-sdk-s3]"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="AWS S3 · Shrine"/><meta property="og:type" content="website"/><meta property="og:url" content="https://shrinerb.com/"/><meta property="og:description" content="The S3 storage handles uploads to Amazon S3 service, using the [aws-sdk-s3]"/><meta property="og:image" content="https://shrinerb.com/img/logo.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://shrinerb.com/img/logo.png"/><link rel="shortcut icon" href="/img/favicon.ico"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-149836844-1', 'auto');
              ga('send', 'pageview');
            </script><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="/js/version.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100}
          )
        });
        </script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/logo.png" alt="Shrine"/><h2 class="headerTitleWithLogo">Shrine</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/docs/getting-started" target="_self">Guides</a></li><li class=""><a href="/docs/plugins/activerecord" target="_self">Plugins</a></li><li class=""><a href="/docs/external/extensions" target="_self">External</a></li><li class=""><a href="https://discourse.shrinerb.com" target="_self">Discourse</a></li><li class=""><a href="https://github.com/shrinerb/shrine" target="_self">GitHub</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Storage</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Base</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/getting-started">Getting Started</a></li><li class="navListItem"><a class="navItem" href="/docs/design">The Design of Shrine</a></li><li class="navListItem"><a class="navItem" href="/docs/retrieving-uploads">Retrieving Uploads</a></li><li class="navListItem"><a class="navItem" href="/docs/attacher">Using Attacher</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Storage</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/storage/file-system">File System</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/storage/s3">AWS S3</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Features</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/direct-s3">Direct Uploads to S3</a></li><li class="navListItem"><a class="navItem" href="/docs/metadata">Extracting Metadata</a></li><li class="navListItem"><a class="navItem" href="/docs/processing">File Processing</a></li><li class="navListItem"><a class="navItem" href="/docs/validation">File Validation</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Extras</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/multiple-files">Multiple Files</a></li><li class="navListItem"><a class="navItem" href="/docs/securing-uploads">Securing uploads</a></li><li class="navListItem"><a class="navItem" href="/docs/testing">Testing with Shrine</a></li><li class="navListItem"><a class="navItem" href="/docs/upgrading-to-3">Upgrading to Shrine 3.x</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Migrating</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/changing-derivatives">Managing Derivatives</a></li><li class="navListItem"><a class="navItem" href="/docs/changing-location">Migrating File Locations</a></li><li class="navListItem"><a class="navItem" href="/docs/changing-storage">Migrating File Storage</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Extending</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/creating-plugins">Writing a Plugin</a></li><li class="navListItem"><a class="navItem" href="/docs/creating-persistence-plugins">Writing a Persistence Plugin</a></li><li class="navListItem"><a class="navItem" href="/docs/creating-storages">Writing a Storage</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Comparison</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/advantages">Advantages of Shrine</a></li><li class="navListItem"><a class="navItem" href="/docs/carrierwave">Shrine for CarrierWave Users</a></li><li class="navListItem"><a class="navItem" href="/docs/paperclip">Shrine for Paperclip Users</a></li><li class="navListItem"><a class="navItem" href="/docs/refile">Shrine for Refile Users</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><a class="edit-page-link button" href="https://github.com/shrinerb/shrine/edit/master/doc/storage/s3.md" target="_blank" rel="noreferrer noopener">Edit</a><h1 class="postHeaderTitle">AWS S3</h1></header><article><div><span><p>The S3 storage handles uploads to Amazon S3 service, using the <a href="https://github.com/aws/aws-sdk-ruby/tree/master/gems/aws-sdk-s3">aws-sdk-s3</a>
gem:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">gem</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>aws-sdk-s3<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>~&gt;&nbsp;1.14<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div></code></pre>
<p>It can be initialized by providing the bucket name and credentials:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">require</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>shrine/storage/s3<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">s3&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Shrine</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Storage</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">S3</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span><span class="punctuation section function ruby">(</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">bucket<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>my-app<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;required&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">access_key_id<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>abc<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">secret_access_key<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>xyz<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">region<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>eu-west-1<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby"><span class="punctuation section function ruby">)</span></span></div></code></pre>
<p>The core features of this storage require the following AWS permissions:
<code>s3:ListBucket</code>, <code>s3:PutObject</code>, <code>s3:GetObject</code>, and <code>s3:DeleteObject</code>. If you
have additional upload options configured such as setting object ACLs, then
additional permissions may be required.</p>
<p>The storage exposes the underlying Aws objects:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">s3<span class="punctuation separator method ruby">.</span>client&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;Aws::S3::Client&gt;&nbsp;</span></span></div><div class="line"><span class="source ruby">s3<span class="punctuation separator method ruby">.</span>client<span class="punctuation separator method ruby">.</span>access_key_id&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;abc&quot;&nbsp;</span></span></div><div class="line"><span class="source ruby">s3<span class="punctuation separator method ruby">.</span>client<span class="punctuation separator method ruby">.</span>secret_access_key&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;xyz&quot;&nbsp;</span></span></div><div class="line"><span class="source ruby">s3<span class="punctuation separator method ruby">.</span>client<span class="punctuation separator method ruby">.</span>region&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;eu-west-1&quot;&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">s3<span class="punctuation separator method ruby">.</span>bucket&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;Aws::S3::Bucket&gt;&nbsp;</span></span></div><div class="line"><span class="source ruby">s3<span class="punctuation separator method ruby">.</span>bucket<span class="punctuation separator method ruby">.</span>name&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;my-app&quot;&nbsp;</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">s3<span class="punctuation separator method ruby">.</span>object<span class="punctuation section function ruby">(</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>key<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;#&lt;Aws::S3::Object&gt;&nbsp;</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="public-uploads"></a><a href="#public-uploads" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Public uploads</h2>
<p>By default, uploaded S3 objects will have private visibility, meaning they can
only be accessed via signed expiring URLs generated using your private S3
credentials. If you would like to generate public URLs, you can tell S3 storage
to make uploads public:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">s3&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Shrine</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Storage</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">S3</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span><span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">public<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant language boolean ruby">true</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="keyword operator arithmetic ruby">**</span>s3_options<span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">s3<span class="punctuation separator method ruby">.</span>upload<span class="punctuation section function ruby">(</span>io<span class="punctuation separator object ruby">,</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>key<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;uploads&nbsp;with&nbsp;&quot;public-read&quot;&nbsp;ACL&nbsp;</span></span></div><div class="line"><span class="source ruby">s3<span class="punctuation separator method ruby">.</span>url<span class="punctuation section function ruby">(</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>key<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;returns&nbsp;public&nbsp;(unsigned)&nbsp;object&nbsp;URL&nbsp;</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="prefix"></a><a href="#prefix" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Prefix</h2>
<p>The <code>:prefix</code> option can be specified for uploading all files inside a specific
S3 prefix (folder), which is useful when using S3 for both cache and store:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Storage</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">S3</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span><span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">prefix<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>cache<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="keyword operator arithmetic ruby">**</span>s3_options<span class="punctuation section function ruby">)</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="upload-options"></a><a href="#upload-options" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Upload options</h2>
<p>Sometimes you'll want to add additional upload options to all S3 uploads. You
can do that by passing the <code>:upload_options</code> option:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Storage</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">S3</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span><span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">upload_options<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="constant other symbol hashkey ruby">acl<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>private<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="punctuation section scope end ruby">}</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="keyword operator arithmetic ruby">**</span>s3_options<span class="punctuation section function ruby">)</span></span></div></code></pre>
<p>These options will be passed to aws-sdk-s3's methods for <a href="http://docs.aws.amazon.com/sdk-for-ruby/v3/api/Aws/S3/Object.html#put-instance_method">uploading</a>, <a href="http://docs.aws.amazon.com/sdk-for-ruby/v3/api/Aws/S3/Object.html#copy_from-instance_method">copying</a>
and <a href="http://docs.aws.amazon.com/sdk-for-ruby/v3/api/Aws/S3/Object.html#presigned_post-instance_method">presigning</a>.</p>
<p>You can also generate upload options per upload with the <code>upload_options</code>
plugin</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta class ruby"><span class="keyword control class ruby">class</span>&nbsp;<span class="entity name type class ruby">MyUploader<span class="entity other inherited-class ruby">&nbsp;<span class="punctuation separator inheritance ruby">&lt;</span>&nbsp;Shrine</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>upload_options</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">store<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="keyword operator arithmetic ruby">-</span><span class="keyword operator comparison ruby">&gt;</span>&nbsp;<span class="punctuation section function ruby">(</span>io<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">derivative<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant language nil ruby">nil</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="keyword operator arithmetic ruby">**</span><span class="punctuation section function ruby">)</span>&nbsp;<span class="keyword control start-block ruby">do</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword control ruby">if</span>&nbsp;derivative&nbsp;<span class="keyword operator comparison ruby">==</span>&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>thumb</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="constant other symbol hashkey ruby">acl<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>public-read<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="punctuation section scope end ruby">}</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword control ruby">else</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="constant other symbol hashkey ruby">acl<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>private<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="punctuation section scope end ruby">}</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="keyword control ruby">end</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<p>or when using the uploader directly</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">uploader<span class="punctuation separator method ruby">.</span>upload<span class="punctuation section function ruby">(</span>file<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">upload_options<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="constant other symbol hashkey ruby">acl<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>private<span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="punctuation section scope end ruby">}</span><span class="punctuation section function ruby">)</span></span></div></code></pre>
<p>Note that, unlike the <code>:upload_options</code> storage option, upload options given on
the uploader level won't be forwarded for generating presigns, since presigns
are generated using the storage directly.</p>
<h2><a class="anchor" aria-hidden="true" id="url-options"></a><a href="#url-options" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>URL options</h2>
<p>Other than <a href="#url-host"><code>:host</code></a> and <a href="#public-uploads"><code>:public</code></a> URL options,
all additional options are forwarded to <a href="https://docs.aws.amazon.com/sdk-for-ruby/v3/api/Aws/S3/Object.html#presigned_url-instance_method"><code>Aws::S3::Object#presigned_url</code></a>.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">s3<span class="punctuation separator method ruby">.</span>url<span class="punctuation section function ruby">(</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">expires_in<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant numeric ruby">15</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">response_content_disposition<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="support class ruby">ContentDisposition</span><span class="punctuation separator method ruby">.</span>attachment<span class="punctuation section function ruby">(</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>my-filename<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">response_content_type<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>foo/bar<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby"><span class="punctuation whitespace comment leading ruby">&nbsp;&nbsp;</span><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;...&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="punctuation section function ruby">)</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="url-host"></a><a href="#url-host" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>URL Host</h2>
<p>If you want your S3 object URLs to be generated with a different URL host (e.g.
a CDN), you can specify the <code>:host</code> option to <code>#url</code>:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">s3<span class="punctuation separator method ruby">.</span>url<span class="punctuation section function ruby">(</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>image.jpg<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">host<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span><span class="markup underline link http hyperlink">http://abc123.cloudfront.net</span><span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;<span class="markup underline link http hyperlink">http://abc123.cloudfront.net/image.jpg</span>&quot;&nbsp;</span></span></div></code></pre>
<p>The host URL can include a path prefix, but it needs to end with a slash:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">s3<span class="punctuation separator method ruby">.</span>url<span class="punctuation section function ruby">(</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>image.jpg<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">host<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span><span class="markup underline link https hyperlink">https://your-s3-host.com/prefix/</span><span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;needs&nbsp;to&nbsp;end&nbsp;with&nbsp;a&nbsp;slash&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;&quot;<span class="markup underline link http hyperlink">http://your-s3-host.com/prefix/image.jpg</span>&quot;&nbsp;</span></span></div></code></pre>
<p>To have the <code>:host</code> option passed automatically for every URL, use the
<code>url_options</code> plugin.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>url_options</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">store<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="constant other symbol hashkey ruby">host<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span><span class="markup underline link http hyperlink">http://abc123.cloudfront.net</span><span class="punctuation definition string end ruby">&quot;</span></span>&nbsp;<span class="punctuation section scope end ruby">}</span></span></div></code></pre>
<p>If you would like to <a href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/PrivateContent.html">serve private content via CloudFront</a>, you need to sign
the object URLs with a special signer, such as <a href="https://docs.aws.amazon.com/sdk-for-ruby/v3/api/Aws/CloudFront/UrlSigner.html"><code>Aws::CloudFront::UrlSigner</code></a>
provided by the <code>aws-sdk-cloudfront</code> gem. The S3 storage initializer accepts a
<code>:signer</code> block, which you can use to call your signer:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="meta require ruby"><span class="keyword other special-method ruby">require</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>aws-sdk-cloudfront<span class="punctuation definition string end ruby">&quot;</span></span></span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby">signer&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Aws</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">CloudFront</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">UrlSigner</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span><span class="punctuation section function ruby">(</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">key_pair_id<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>cf-keypair-id<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">private_key_path<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>./cf_private_key.pem<span class="punctuation definition string end ruby">&quot;</span></span></span></div><div class="line"><span class="source ruby"><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Storage</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">S3</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span><span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">signer<span class="punctuation definition constant ruby">:</span></span>&nbsp;signer<span class="punctuation separator method ruby">.</span>method<span class="punctuation section function ruby">(</span><span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>signed_url</span><span class="punctuation section function ruby">))</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;or&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Storage</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">S3</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span><span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">signer<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="keyword operator arithmetic ruby">-</span><span class="keyword operator comparison ruby">&gt;</span>&nbsp;<span class="punctuation section function ruby">(</span>url<span class="punctuation separator object ruby">,</span>&nbsp;<span class="keyword operator arithmetic ruby">**</span>options<span class="punctuation section function ruby">)</span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span>signer<span class="punctuation separator method ruby">.</span>signed_url<span class="punctuation section function ruby">(</span>url<span class="punctuation separator object ruby">,</span>&nbsp;<span class="keyword operator arithmetic ruby">**</span>options<span class="punctuation section function ruby">)</span>&nbsp;<span class="punctuation section scope end ruby">}</span><span class="punctuation section function ruby">)</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="presigns"></a><a href="#presigns" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Presigns</h2>
<p>The <code>#presign</code> method can be used for generating paramters for direct uploads
to Amazon S3:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">s3<span class="punctuation separator method ruby">.</span>presign<span class="punctuation section function ruby">(</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>/path/to/file<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>=&gt;&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;{&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;&nbsp;&nbsp;url:&nbsp;&quot;<span class="markup underline link https hyperlink">https://my-bucket.s3.amazonaws.com/</span>...&quot;,&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;&nbsp;&nbsp;fields:&nbsp;{&nbsp;...&nbsp;},&nbsp;&nbsp;#&nbsp;blank&nbsp;for&nbsp;PUT&nbsp;presigns&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;&nbsp;&nbsp;headers:&nbsp;{&nbsp;...&nbsp;},&nbsp;#&nbsp;blank&nbsp;for&nbsp;POST&nbsp;presigns&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;&nbsp;&nbsp;method:&nbsp;&quot;post&quot;,&nbsp;</span></span></div><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;}&nbsp;</span></span></div></code></pre>
<p>Additional presign options can be given in three places:</p>
<ul>
<li>in <code>Storage::S3#presign</code> by forwarding options</li>
<li>in <code>:upload_options</code> option on this storage</li>
<li>in <code>presign_endpoint</code> plugin through <code>:presign_options</code></li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="large-files"></a><a href="#large-files" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Large files</h2>
<p>The aws-sdk-s3 gem has the ability to automatically use multipart upload/copy
for larger files, splitting the file into multiple chunks and uploading/copying
them in parallel.</p>
<p>By default any files that are uploaded will use the multipart upload if they're
larger than 15MB, and any files that are copied will use the multipart copy if
they're larger than 150MB, but you can change the thresholds via
<code>:multipart_threshold</code>.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">thresholds&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="constant other symbol hashkey ruby">upload<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant numeric ruby">30</span><span class="keyword operator arithmetic ruby">*</span><span class="constant numeric ruby">1024</span><span class="keyword operator arithmetic ruby">*</span><span class="constant numeric ruby">1024</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">copy<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant numeric ruby">200</span><span class="keyword operator arithmetic ruby">*</span><span class="constant numeric ruby">1024</span><span class="keyword operator arithmetic ruby">*</span><span class="constant numeric ruby">1024</span>&nbsp;<span class="punctuation section scope end ruby">}</span></span></div><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Storage</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">S3</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span><span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">multipart_threshold<span class="punctuation definition constant ruby">:</span></span>&nbsp;thresholds<span class="punctuation separator object ruby">,</span>&nbsp;<span class="keyword operator arithmetic ruby">**</span>s3_options<span class="punctuation section function ruby">)</span></span></div></code></pre>
<p>If you want to change how many threads aws-sdk-s3 will use for multipart
upload/copy, you can use the <code>upload_options</code> plugin to specify
<code>:thread_count</code>.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">plugin&nbsp;<span class="constant other symbol ruby"><span class="punctuation definition constant ruby">:</span>upload_options</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">store<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="keyword operator arithmetic ruby">-</span><span class="keyword operator comparison ruby">&gt;</span>&nbsp;<span class="punctuation section function ruby">(</span>io<span class="punctuation separator object ruby">,</span>&nbsp;context<span class="punctuation section function ruby">)</span>&nbsp;<span class="keyword control start-block ruby">do</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="constant other symbol hashkey ruby">thread_count<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant numeric ruby">5</span>&nbsp;<span class="punctuation section scope end ruby">}</span></span></div><div class="line"><span class="source ruby"><span class="keyword control ruby">end</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="encryption"></a><a href="#encryption" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Encryption</h2>
<p>The easiest way to use server-side encryption for uploaded S3 objects is to
configure default encryption for your S3 bucket. Alternatively, you can pass
server-side encryption parameters to the API calls.</p>
<p>The <code>#upload</code> method accepts <code>:sse_*</code> options:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">s3<span class="punctuation separator method ruby">.</span>upload<span class="punctuation section function ruby">(</span>io<span class="punctuation separator object ruby">,</span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>key<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">sse_customer_algorithm<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>AES256<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">sse_customer_key<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>secret_key<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">sse_customer_key_md5<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>secret_key_md5<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">ssekms_key_id<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>key_id<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span></span></div></code></pre>
<p>The <code>#presign</code> method accepts <code>:server_side_encryption_*</code> options for POST
presigns, and the same <code>:sse_*</code> options as above for PUT presigns.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">s3<span class="punctuation separator method ruby">.</span>presign<span class="punctuation section function ruby">(</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>key<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">server_side_encryption_customer_algorithm<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>AES256<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">server_side_encryption_customer_key<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>secret_key<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">server_side_encryption_aws_kms_key_id<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>key_id<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span></span></div></code></pre>
<p>When downloading encrypted S3 objects, the same server-side encryption
parameters need to be passed in.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">s3<span class="punctuation separator method ruby">.</span><span class="support function kernel ruby">open</span><span class="punctuation section function ruby">(</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>key<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">sse_customer_algorithm<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>AES256<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">sse_customer_key<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>secret_key<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation separator object ruby">,</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">sse_customer_key_md5<span class="punctuation definition constant ruby">:</span></span>&nbsp;&nbsp;&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>secret_key_md5<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span></span></div></code></pre>
<p>If you want to use client-side encryption instead, you can instantiate the
storage with an <code>Aws::S3::Encryption::Client</code> instance.</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">client&nbsp;<span class="keyword operator assignment ruby">=</span>&nbsp;<span class="support class ruby">Aws</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">S3</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Encryption</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Client</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span><span class="punctuation section function ruby">(</span></span></div><div class="line"><span class="source ruby">&nbsp;&nbsp;<span class="constant other symbol hashkey ruby">kms_key_id<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>alias/my-key<span class="punctuation definition string end ruby">&quot;</span></span></span></div><div class="line"><span class="source ruby"><span class="punctuation section function ruby">)</span></span></div><div class="line"><span class="source ruby">&nbsp;</span></div><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Storage</span><span class="punctuation separator other ruby">::</span><span class="variable other constant ruby">S3</span><span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">client<span class="punctuation definition constant ruby">:</span></span>&nbsp;client<span class="punctuation separator object ruby">,</span>&nbsp;<span class="constant other symbol hashkey ruby">bucket<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>my-bucket<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="accelerate-endpoint"></a><a href="#accelerate-endpoint" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Accelerate endpoint</h2>
<p>To use Amazon S3's <a href="http://docs.aws.amazon.com/AmazonS3/latest/dev/transfer-acceleration.html">Transfer Acceleration</a> feature, set
<code>:use_accelerate_endpoint</code> to <code>true</code> when initializing the storage:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="support class ruby">Shrine</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">Storage</span><span class="punctuation separator other ruby">::</span><span class="support class ruby">S3</span><span class="punctuation separator method ruby">.</span><span class="keyword other special-method ruby">new</span><span class="punctuation section function ruby">(</span><span class="constant other symbol hashkey ruby">use_accelerate_endpoint<span class="punctuation definition constant ruby">:</span></span>&nbsp;<span class="constant language boolean ruby">true</span><span class="punctuation separator object ruby">,</span>&nbsp;<span class="keyword operator arithmetic ruby">**</span>other_options<span class="punctuation section function ruby">)</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="deleting-prefixed"></a><a href="#deleting-prefixed" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Deleting prefixed</h2>
<p>If you want to delete all objects in some prefix, you can use
<code>S3#delete_prefixed</code>:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby">s3<span class="punctuation separator method ruby">.</span>delete_prefixed<span class="punctuation section function ruby">(</span><span class="string quoted double interpolated ruby"><span class="punctuation definition string begin ruby">&quot;</span>some_prefix/<span class="punctuation definition string end ruby">&quot;</span></span><span class="punctuation section function ruby">)</span>&nbsp;<span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;deletes&nbsp;all&nbsp;objects&nbsp;in&nbsp;&quot;some_prefix/&quot;&nbsp;</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="clearing-cache"></a><a href="#clearing-cache" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Clearing cache</h2>
<p>If you're using S3 as a cache, you will probably want to periodically delete
old files which aren't used anymore. S3 has a built-in way to do this, read
<a href="http://docs.aws.amazon.com/AmazonS3/latest/UG/lifecycle-configuration-bucket-no-versioning.html">this article</a> for instructions.</p>
<p>Alternatively you can periodically call the <code>#clear!</code> method:</p>
<pre><code class="language-rb"><div class="line"><span class="source ruby"><span class="comment line number-sign ruby"><span class="punctuation definition comment ruby">#</span>&nbsp;deletes&nbsp;all&nbsp;objects&nbsp;that&nbsp;were&nbsp;uploaded&nbsp;more&nbsp;than&nbsp;7&nbsp;days&nbsp;ago&nbsp;</span></span></div><div class="line"><span class="source ruby">s3<span class="punctuation separator method ruby">.</span>clear!&nbsp;<span class="punctuation section scope begin ruby">{</span><span class="meta syntax ruby start-block">&nbsp;</span><span class="punctuation separator variable ruby">|</span><span class="variable other block ruby">object</span><span class="punctuation separator variable ruby">|</span>&nbsp;object<span class="punctuation separator method ruby">.</span>last_modified&nbsp;<span class="keyword operator comparison ruby">&lt;</span>&nbsp;<span class="support class ruby">Time</span><span class="punctuation separator method ruby">.</span>now&nbsp;<span class="keyword operator arithmetic ruby">-</span>&nbsp;<span class="constant numeric ruby">7</span><span class="keyword operator arithmetic ruby">*</span><span class="constant numeric ruby">24</span><span class="keyword operator arithmetic ruby">*</span><span class="constant numeric ruby">60</span><span class="keyword operator arithmetic ruby">*</span><span class="constant numeric ruby">60</span>&nbsp;<span class="punctuation section scope end ruby">}</span></span></div></code></pre>
<h2><a class="anchor" aria-hidden="true" id="request-rate-and-performance-guidelines"></a><a href="#request-rate-and-performance-guidelines" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Request Rate and Performance Guidelines</h2>
<p>Amazon S3 automatically scales to high request rates. For example, your
application can achieve at least 3,500 PUT/POST/DELETE and 5,500 GET requests
per second per prefix in a bucket (a prefix is a top-level &quot;directory&quot; in the
bucket). If your app needs to support higher request rates to S3 than that, you
can scale exponentially by using more prefixes.</p>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/storage/file-system"><span class="arrow-prev">← </span><span>File System</span></a><a class="docs-next button" href="/docs/direct-s3"><span>Direct Uploads to S3</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#public-uploads">Public uploads</a></li><li><a href="#prefix">Prefix</a></li><li><a href="#upload-options">Upload options</a></li><li><a href="#url-options">URL options</a></li><li><a href="#url-host">URL Host</a></li><li><a href="#presigns">Presigns</a></li><li><a href="#large-files">Large files</a></li><li><a href="#encryption">Encryption</a></li><li><a href="#accelerate-endpoint">Accelerate endpoint</a></li><li><a href="#deleting-prefixed">Deleting prefixed</a></li><li><a href="#clearing-cache">Clearing cache</a></li><li><a href="#request-rate-and-performance-guidelines">Request Rate and Performance Guidelines</a></li></ul></nav></div><footer class="nav-footer" id="footer" data-version="3.0.1"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/logo.png" alt="Shrine" width="66"/></a><div><h5>Docs</h5><a href="/guides">Guides</a><a href="/plugins">Plugins</a><a href="/external">External</a><a href="https://github.com/shrinerb/shrine/blob/master/CONTRIBUTING.md#readme">Contributing</a></div><div><h5>Community</h5><a href="https://discourse.shrinerb.com" target="_blank" rel="noreferrer noopener">Discourse</a><a href="https://stackoverflow.com/questions/tagged/shrine" target="_blank" rel="noreferrer noopener">Stack Overflow</a></div><div><h5>More</h5><a href="https://twin.github.io">Blog</a><a href="https://github.com/shrinerb/shrine">GitHub</a><a class="github-button" href="https://github.com/shrinerb/shrine" data-icon="octicon-star" data-count-href="/shrinerb/shrine/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a><div class="social"><a href="https://twitter.com/shrine_rb" class="twitter-follow-button">Follow @shrine_rb</a></div></div></section><section class="copyright">Copyright © 2019 Janko Marohnić</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>window.twttr=(function(d,s, id){var js,fjs=d.getElementsByTagName(s)[0],t=window.twttr||{};if(d.getElementById(id))return t;js=d.createElement(s);js.id=id;js.src='https://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js, fjs);t._e = [];t.ready = function(f) {t._e.push(f);};return t;}(document, 'script', 'twitter-wjs'));</script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: '09a11b10801874df7d226df4f2ce8e8f',
                indexName: 'shrinerb',
                inputSelector: '#search_input_react'
              });
            </script></body></html>